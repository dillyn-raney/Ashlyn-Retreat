// REPLACE the DOMContentLoaded section in app.js (lines 8-44) with this:

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // FIREBASE INITIALIZATION FIRST
        if (window.firebaseFeatures && window.firebaseFeatures.enabled) {
            console.log('Firebase enabled, initializing...');
            const firebaseInitialized = await FirebaseSync.init();

            if (firebaseInitialized) {
                console.log('Firebase initialized, waiting for authentication...');
                // Setup Firebase UI handlers
                if (typeof setupFirebaseUI === 'function') {
                    setupFirebaseUI();
                }
                // Don't initialize app yet - wait for auth state change
                // The handleAuthStateChange in firebase.js will call initializeApp()
                return;
            } else {
                console.log('Firebase failed to initialize, continuing in offline mode');
            }
        } else {
            console.log('Firebase disabled, running in offline mode');
            // Hide auth modal, show app
            const authModal = document.getElementById('authModal');
            if (authModal) authModal.style.display = 'none';
        }

        // Initialize app immediately (Firebase disabled or failed)
        await initializeApp();

    } catch (error) {
        console.error('Error during initialization:', error);
        alert('Error loading application. Please refresh the page.');
    }
});

// Main app initialization function
async function initializeApp() {
    console.log('Initializing app...');
    
    try {
        // Load retreat data
        await loadRetreatData();

        // Initialize user
        currentUser = Storage.getCurrentUser();
        updateUserDisplay();

        // Setup event listeners
        setupEventListeners();

        // Render all sections
        renderSchedule();
        renderMeals();
        renderSupplies();
        renderPrompts();
        loadJournalData();
        loadToolsData();

        // Setup countdown timer
        updateCountdownTimer();
        setInterval(updateCountdownTimer, 60000);

        // Update progress
        updateSuppliesProgress();

        // Setup smooth scrolling
        setupSmoothScrolling();

        console.log('App initialized successfully');
    } catch (error) {
        console.error('Error initializing app:', error);
        alert('Error loading retreat data. Please refresh the page.');
    }
}

// Make initializeApp global so Firebase can call it
window.initializeApp = initializeApp;

